{% macro render_comment(comment, post_id, user, depth=0) %}
<div class="{% if depth > 0 %}py-2{% else %}border-l-2 border-gray-200 pl-4 py-3{% endif %}" id="comment-{{ comment.id }}">
    <div class="flex items-start justify-between">
        <div class="flex items-center space-x-2 mb-{% if depth > 0 %}1{% else %}2{% endif %}">
            <span class="font-medium {% if depth > 0 %}text-gray-800 text-sm{% else %}text-gray-900{% endif %}">{{ comment.author.display_name }}</span>
            <span class="text-gray-400 {% if depth > 0 %}text-xs{% else %}text-sm{% endif %}">{{ comment.created_at.strftime('%d.%m.%Y в %H:%M') if depth == 0 else comment.created_at.strftime('%d.%m в %H:%M') }}</span>
        </div>
        {% if user and (user.id == comment.author_id or user.is_admin) %}
        <button type="button"
                hx-delete="/api/v1/comments/{{ comment.id }}"
                hx-target="#comment-{{ comment.id }}"
                hx-swap="outerHTML"
                hx-confirm="Удалить этот комментарий?"
                class="text-gray-400 hover:text-red-500 {% if depth > 0 %}text-xs{% else %}text-sm{% endif %}">
            Удалить
        </button>
        {% endif %}
    </div>
    <p class="{% if depth > 0 %}text-gray-600 text-sm{% else %}text-gray-700{% endif %} whitespace-pre-wrap">{{ comment.content }}</p>

    {% if user %}
    <button type="button"
            class="reply-btn text-blue-500 hover:text-blue-700 text-xs mt-1"
            data-comment-id="{{ comment.id }}"
            data-post-id="{{ post_id }}">
        Ответить
    </button>
    <div id="reply-form-{{ comment.id }}" class="reply-form-container hidden">
        <form hx-post="/api/v1/comments/{{ post_id }}"
              hx-target="#replies-{{ comment.id }}"
              hx-swap="beforeend"
              hx-disabled-elt="button[type='submit']"
              class="mt-2 pl-4 border-l border-blue-200 reply-form">
            <input type="hidden" name="parent_id" value="{{ comment.id }}">
            <textarea name="content"
                      rows="2"
                      placeholder="Написать ответ..."
                      class="w-full px-3 py-2 text-sm border rounded-lg focus:ring-2 focus:ring-blue-500"
                      required></textarea>
            <div class="flex gap-2 mt-2">
                <button type="submit"
                        class="px-3 py-1 text-sm bg-blue-500 text-white rounded hover:bg-blue-600">
                    Ответить
                </button>
                <button type="button"
                        class="cancel-reply px-3 py-1 text-sm text-gray-500 hover:text-gray-700">
                    Отмена
                </button>
            </div>
        </form>
    </div>
    {% endif %}

    <div id="replies-{{ comment.id }}" class="{% if comment._replies is defined and comment._replies %}mt-3 ml-4 space-y-3 border-l border-gray-100 pl-4{% endif %}">
        {% if comment._replies is defined and comment._replies %}
            {% for reply in comment._replies %}
                {{ render_comment(reply, post_id, user, depth + 1) }}
            {% endfor %}
        {% endif %}
    </div>
</div>
{% endmacro %}

{% if comments %}
<div class="space-y-4">
    {% for comment in comments %}
        {{ render_comment(comment, post_id, user, 0) }}
    {% endfor %}
</div>

<script>
document.addEventListener('click', function(e) {
    // Handle reply button click
    if (e.target.classList.contains('reply-btn')) {
        const commentId = e.target.dataset.commentId;
        const container = document.getElementById('reply-form-' + commentId);
        if (container) {
            container.classList.toggle('hidden');
            if (!container.classList.contains('hidden')) {
                const textarea = container.querySelector('textarea');
                if (textarea) textarea.focus();
            }
        }
    }
    // Handle cancel button click
    if (e.target.classList.contains('cancel-reply')) {
        const container = e.target.closest('.reply-form-container');
        if (container) {
            container.classList.add('hidden');
            const form = container.querySelector('form');
            if (form) form.reset();
        }
    }
});

// Hide form and reset after successful submission
document.body.addEventListener('htmx:afterRequest', function(e) {
    if (e.detail.successful && e.target.classList.contains('reply-form')) {
        const container = e.target.closest('.reply-form-container');
        if (container) {
            container.classList.add('hidden');
            e.target.reset();
        }
    }
});
</script>
{% else %}
<p class="text-gray-500">Комментариев пока нет.</p>
{% endif %}
